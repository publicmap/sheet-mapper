<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Mapper</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/papaparse@5.3.0/papaparse.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 60px; bottom: 0; right: 0; left: 300px; }
        #sidebar { position: absolute; top: 60px; bottom: 0; left: 0; width: 300px; overflow-y: auto; background-color: white; padding: 10px; }
        .sidebar-item:hover { background-color: #f0f0f0; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="fixed top-0 left-0 right-0 z-10 bg-white shadow-md p-4">
        <div id="filterContainer" class="container mx-auto flex flex-wrap space-x-4">
            <!-- Filters will be dynamically added here -->
        </div>
    </div>
    <div id="sidebar"></div>
    <div id="map"></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiY2x2MzZwbGRyMGdheDJtbXVwdDA4aDNyaCJ9.nbvz6aNGQo68xa4NtWH26A';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [73.8567, 18.5204],
            zoom: 5,
            hash: true
        });

        // Add geolocate control
        const geolocate = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        });
        map.addControl(geolocate);

        const urlParams = new URLSearchParams(window.location.search);
        const sheetId = urlParams.get('sheetId');

        if (!sheetId) {
            console.error('No sheet ID provided in URL parameters');
        } else {
            const sheetUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?single=true&output=csv`;

            map.on('load', () => {
                Papa.parse(sheetUrl, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        const data = results.data.filter(row => row.Latitude && row.Longitude);
                        
                        console.log("Sheet CSV",data);

                        const geojson = {
                            type: 'FeatureCollection',
                            features: data.map(row => ({
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [parseFloat(row.Longitude), parseFloat(row.Latitude)]
                                },
                                properties: row
                            }))
                        };

                        map.addSource('deals', {
                            type: 'geojson',
                            data: geojson
                        });

                        map.addLayer({
                            id: 'deals',
                            type: 'circle',
                            source: 'deals',
                            paint: {
                                'circle-radius': 6,
                                'circle-color': [
                                    'case',
                                    ['has', 'marker-color'],
                                    ['get', 'marker-color'],
                                    '#B42222'
                                ],
                                'circle-stroke-width': 1,
                                'circle-stroke-color': '#ffffff',
                                'circle-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0.5]
                            }
                        });

                        // Add center marker
                        const centerMarker = new mapboxgl.Marker({ color: '#000000' })
                            .setLngLat(map.getCenter())
                            .addTo(map);

                        function updateSidebar() {
                            const center = map.getCenter();
                            const features = map.queryRenderedFeatures({ layers: ['deals'] });
                            
                            // Calculate distances and sort
                            const sortedFeatures = features.map(f => ({
                                ...f,
                                distance: turf.distance(
                                    turf.point([center.lng, center.lat]),
                                    turf.point(f.geometry.coordinates)
                                )
                            })).sort((a, b) => a.distance - b.distance).slice(0, 5);

                            // Update sidebar
                            const sidebar = document.getElementById('sidebar');
                            sidebar.innerHTML = '<h2 class="text-lg font-bold mb-4">Nearest Locations</h2>';
                            sortedFeatures.forEach(f => {
                                const div = document.createElement('div');
                                div.className = 'mb-4 p-2 bg-gray-100 rounded sidebar-item';
                                div.innerHTML = `
                                    <h3 class="font-bold">${f.properties.name || 'Unnamed'}</h3>
                                    <p>Distance: ${f.distance.toFixed(2)} km</p>
                                    <p>Category: ${f.properties['Project Category'] || 'N/A'}</p>
                                    <p>Amount: ${f.properties['Total Amount'] || 'N/A'}</p>
                                `;
                                div.addEventListener('mouseenter', () => {
                                    map.flyTo({
                                        center: f.geometry.coordinates,
                                        zoom: 12
                                    });
                                });
                                sidebar.appendChild(div);
                            });
                        }

                        // Update on map move
                        map.on('moveend', () => {
                            centerMarker.setLngLat(map.getCenter());
                            updateSidebar();
                        });

                        // Initial update
                        updateSidebar();

                        map.on('click', 'deals', (e) => {
                            const coordinates = e.features[0].geometry.coordinates.slice();
                            const properties = e.features[0].properties;

                            let popupContent = '<div style="max-height: 300px; overflow-y: auto;"><table class="min-w-full divide-y divide-gray-200 text-xs">';
                            
                            // Add URL to the top if it exists
                            if (properties.url || properties.URL || properties.Url) {
                                const url = properties.url || properties.URL || properties.Url;
                                popupContent += `<tr><td colspan="2" class="px-2 py-1 whitespace-nowrap text-center"><a href="${url}" target="_blank" class="text-blue-500 hover:text-blue-700">View Details</a></td></tr>`;
                            }
                            
                            for (const [key, value] of Object.entries(properties)) {
                                if (key.toLowerCase() !== 'url') {
                                    popupContent += `<tr><td class="px-2 py-1 whitespace-nowrap font-medium text-gray-900">${key}:</td><td class="px-2 py-1 whitespace-nowrap text-gray-500">${value}</td></tr>`;
                                }
                            }
                            popupContent += '</table></div>';

                            new mapboxgl.Popup()
                                .setLngLat(coordinates)
                                .setHTML(popupContent)
                                .addTo(map);
                        });

                        map.on('mouseenter', 'deals', () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });

                        map.on('mouseleave', 'deals', () => {
                            map.getCanvas().style.cursor = '';
                        });

                        // Create filters dynamically
                        const filterContainer = document.getElementById('filterContainer');
                        const fields = Object.keys(data[0]).slice(0, 4);
                        const filters = {};

                        fields.forEach(field => {
                            const values = [...new Set(data.map(item => item[field]))];
                            const select = document.createElement('select');
                            select.id = `${field}Filter`;
                            select.className = 'p-2 border rounded';
                            select.innerHTML = `<option value="">All ${field}</option>`;
                            values.forEach(value => {
                                const option = document.createElement('option');
                                option.value = value;
                                option.textContent = value;
                                select.appendChild(option);
                            });
                            filterContainer.appendChild(select);
                            filters[field] = select;

                            select.addEventListener('change', applyFilters);
                        });

                        function applyFilters() {
                            const filterConditions = Object.entries(filters).map(([field, select]) => {
                                const value = select.value;
                                return value ? ['==', ['get', field], value] : true;
                            });

                            map.setFilter('deals', ['all', ...filterConditions]);
                            updateSidebar();
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
