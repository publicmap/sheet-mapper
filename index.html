<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Mapper</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/papaparse@5.3.0/papaparse.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css' type='text/css' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 60px; bottom: 0; right: 0; left: 300px; }
        #sidebar { position: absolute; top: 60px; bottom: 0; left: 0; width: 300px; overflow-y: auto; background-color: white; padding: 10px; }
        .sidebar-item:hover { background-color: #f0f0f0; cursor: pointer; }
        #filterContainer select { font-size: 0.875rem; padding: 0.25rem 0.5rem; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="fixed top-0 left-0 right-0 z-10 bg-white shadow-md p-2">
        <div id="filterContainer" class="container mx-auto flex flex-wrap items-center justify-start gap-2">
            <!-- Filters will be dynamically added here -->
        </div>
    </div>
    <div id="sidebar"></div>
    <div id="map"></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiY2x2MzZwbGRyMGdheDJtbXVwdDA4aDNyaCJ9.nbvz6aNGQo68xa4NtWH26A';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/planemad/clzsr0s3c00f701pihaefhc37',
            center: [73.8567, 18.5204],
            zoom: 5,
            hash: true
        });

                // Add geocoder control
                const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
        });
        map.addControl(geocoder);

        // Add geolocate control
        const geolocate = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        });
        map.addControl(geolocate, 'top-right');



        const urlParams = new URLSearchParams(window.location.search);
        const sheetId = urlParams.get('sheetId');

        if (!sheetId) {
            console.error('No sheet ID provided in URL parameters');
        } else {
            const sheetUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?single=true&output=csv`;

            map.on('load', () => {
                Papa.parse(sheetUrl, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        const data = results.data.filter(row => row.Latitude && row.Longitude);
                        console.log("Sheet CSV", data);

                        const validRows = [];
                        const invalidRows = [];

                        // Function to detect field type
                        function detectFieldType(value) {
                            if (!isNaN(parseFloat(value))) return 'number';
                            if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') return 'boolean';
                            return 'string';
                        }

                        // Detect field types
                        const fieldTypes = {};
                        if (data.length > 0) {
                            Object.keys(data[0]).forEach(key => {
                                fieldTypes[key] = detectFieldType(data[0][key]);
                            });
                        }

                        data.forEach(row => {
                            const lon = parseFloat(row.Longitude);
                            const lat = parseFloat(row.Latitude);
                            if (!isNaN(lon) && !isNaN(lat) && 
                                lon >= -180 && lon <= 180 && 
                                lat >= -90 && lat <= 90) {
                                // Convert fields based on detected types
                                Object.keys(row).forEach(key => {
                                    switch (fieldTypes[key]) {
                                        case 'number':
                                            row[key] = parseFloat(row[key]);
                                            break;
                                        case 'date':
                                            row[key] = new Date(row[key]);
                                            break;
                                        case 'boolean':
                                            row[key] = row[key].toLowerCase() === 'true';
                                            break;
                                    }
                                });
                                validRows.push(row);
                            } else {
                                invalidRows.push(row);
                            }
                        });

                        console.log("Field types:", fieldTypes);
                        console.log("Invalid rows:", invalidRows);

                        const geojson = {
                            type: 'FeatureCollection',
                            features: validRows.map(row => ({
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [row.Longitude, row.Latitude]
                                },
                                properties: row
                            }))
                        };

                        map.addSource('deals', {
                            type: 'geojson',
                            data: geojson
                        });

                        map.addLayer({
                            id: 'deals',
                            type: 'circle',
                            source: 'deals',
                            paint: {
                                'circle-radius': [
                                    'interpolate',
                                    ['linear'],
                                    ['zoom'],
                                    10, ['case', ['has', 'circle-radius'], ['to-number', ['get', 'circle-radius']], 3],
                                    16, ['*', 2, ['case', ['has', 'circle-radius'], ['to-number', ['get', 'circle-radius']], 3]]
                                ],
                                'circle-color': [
                                    'case',
                                    ['has', 'circle-color'],
                                    ['get', 'circle-color'],
                                    'grey'
                                ],
                                'circle-stroke-width': 2,
                                'circle-stroke-color': '#ffffff',
                                'circle-opacity': 1
                            }
                        });

                        // Add center marker
                        const centerMarker = new mapboxgl.Marker({ color: '#000000' })
                            .setLngLat(map.getCenter())
                            .addTo(map);

                        function updateSidebar() {
                            const center = map.getCenter();
                            const features = map.queryRenderedFeatures({ layers: ['deals'] });
                            
                            // Calculate distances and sort
                            const sortedFeatures = features.map(f => ({
                                ...f,
                                distance: turf.distance(
                                    turf.point([center.lng, center.lat]),
                                    turf.point(f.geometry.coordinates)
                                )
                            })).sort((a, b) => a.distance - b.distance).slice(0, 5);

                            // Update sidebar
                            const sidebar = document.getElementById('sidebar');
                            sidebar.innerHTML = '<h2 class="text-lg font-bold mb-4">Nearest Locations</h2>';
                            sortedFeatures.forEach(f => {
                                const div = document.createElement('div');
                                div.className = 'mb-4 p-2 bg-gray-100 rounded sidebar-item';
                                div.innerHTML = `
                                    <h3 class="font-bold">Distance: ${f.distance.toFixed(2)} km</h3>
                                    <h4>${f.properties['name'] || 'N/A'}<h4>
                                    <p>Address: ${f.properties['Address'] || 'N/A'}</p>
                                    <p>Category: ${f.properties['Project Category'] || 'N/A'}</p>
                                    <p>Amount: ${f.properties['Total Amount'] || 'N/A'}</p>
                                `;
                                div.addEventListener('mouseenter', () => {
                                    map.flyTo({
                                        center: f.geometry.coordinates,
                                        zoom: 12
                                    });
                                });
                                div.addEventListener('click', () => {
                                    map.flyTo({
                                        center: f.geometry.coordinates,
                                        zoom: 14
                                    });
                                });
                                sidebar.appendChild(div);
                            });
                        }

                        // Update on map move
                        map.on('moveend', () => {
                            centerMarker.setLngLat(map.getCenter());
                            updateSidebar();
                        });

                        // Initial update
                        updateSidebar();

                        map.on('click', 'deals', (e) => {
                            const coordinates = e.features[0].geometry.coordinates.slice();
                            const properties = e.features[0].properties;

                            let popupContent = '<div style="max-height: 300px; overflow-y: auto;"><table class="min-w-full divide-y divide-gray-200 text-xs">';
                            
                            // Add URL to the top if it exists
                            if (properties.url || properties.URL || properties.Url) {
                                const url = properties.url || properties.URL || properties.Url;
                                popupContent += `<tr><td colspan="2" class="px-2 py-1 whitespace-nowrap text-center"><a href="${url}" target="_blank" class="text-blue-500 hover:text-blue-700">View Details</a></td></tr>`;
                            }
                            
                            for (const [key, value] of Object.entries(properties)) {
                                if (key.toLowerCase() !== 'url') {
                                    popupContent += `<tr><td class="px-2 py-1 whitespace-nowrap font-medium text-gray-900">${key}:</td><td class="px-2 py-1 whitespace-nowrap text-gray-500">${value}</td></tr>`;
                                }
                            }
                            popupContent += '</table></div>';

                            new mapboxgl.Popup()
                                .setLngLat(coordinates)
                                .setHTML(popupContent)
                                .addTo(map);
                        });

                        map.on('mouseenter', 'deals', () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });

                        map.on('mouseleave', 'deals', () => {
                            map.getCanvas().style.cursor = '';
                        });

                        // Create filters dynamically
                        const filterContainer = document.getElementById('filterContainer');
                        const fields = Object.keys(data[0]).slice(0, 4);
                        const filters = {};

                        fields.forEach(field => {
                            const values = [...new Set(data.map(item => item[field]))];
                            const select = document.createElement('select');
                            select.id = `${field}Filter`;
                            select.className = 'text-sm border rounded';
                            select.innerHTML = `<option value="">All ${field}</option>`;
                            values.forEach(value => {
                                const option = document.createElement('option');
                                option.value = value;
                                option.textContent = value;
                                select.appendChild(option);
                            });
                            filterContainer.appendChild(select);
                            filters[field] = select;

                            select.addEventListener('change', applyFilters);
                        });

                        function applyFilters() {
                            const filterConditions = Object.entries(filters).map(([field, select]) => {
                                const value = select.value;
                                return value ? ['==', ['get', field], value] : true;
                            });

                            map.setFilter('deals', ['all', ...filterConditions]);
                            updateSidebar();
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
